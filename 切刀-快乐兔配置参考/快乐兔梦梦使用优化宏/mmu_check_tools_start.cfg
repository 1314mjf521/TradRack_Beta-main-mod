# =====此处代码用于自定义优化代码=========
# 2025-8-29  MMU_tools_start 打印开始检测代码替换 MMU_START_CHECK，用于避免每次开始打印都需要全通道检测_V1.10

[gcode_macro MMU_tools_start]
description: MMU预加载检测宏。结合gate_status，确保批量和单通道检测都精准识别通道实际加载状态。
gcode:
    # ==== 批量检测自动判别，无需手动配置 ====

    {% set vars = printer['gcode_macro _MMU_SOFTWARE_VARS'] %}
    {% set check_gates = vars.check_gates|lower == 'true' %}
    {% set using_bypass = printer.mmu.tool == -2 %}
    {% set slicer_tool_map = printer.mmu.slicer_tool_map %}
    {% set referenced_tools = slicer_tool_map.referenced_tools %}
    {% set is_batch = referenced_tools|length > 1 %}
    {% set requested_tool = printer.mmu.next_tool if printer.mmu.next_tool != -1 else printer.mmu.tool %}
    {% set tool_known = requested_tool >= 0 and requested_tool < printer.mmu.num_gates %}
    {% set gate_status = printer.mmu.gate_status %}
    {% set requested_tool_status = gate_status[requested_tool]|default(-1) if tool_known else -99 %}
    {% set requested_tool_need_check = requested_tool_status == 0 or requested_tool_status == -1 %}

    {% if printer.mmu.enabled %}
        {% if not using_bypass %}
            {% if is_batch %}
                # 自动批量检测分支，只检测空或未知状态通道
                {% set tools_to_check = [] %}
                {% for t in referenced_tools %}
                    {% set status = gate_status[t]|default(-1) %}
                    {% if status == 0 or status == -1 %}
                        {% set _ = tools_to_check.append(t) %}
                    {% endif %}
                {% endfor %}
                {% if tools_to_check|length > 0 and check_gates %}
                    {% set log_msg = "批量检测：部分工具通道未加载（空或未知），正在检测：" ~ tools_to_check|join(',') %}
                    MMU_LOG MSG="{log_msg}"
                    {% if not printer.mmu.is_homed %}
                        MMU_HOME
                    {% endif %}
                    MMU_CHECK_GATE TOOLS={tools_to_check|join(",")}
                {% else %}
                    MMU_LOG MSG="批量检测：所有需要的工具通道均已加载，无需检测。"
                {% endif %}
            {% elif tool_known %}
                # 单通道检测分支，仅检测当前/下一个工具通道是否为空或未知
                {% if requested_tool_need_check %}
                    {% if check_gates %}
                        {% set log_msg2 = "单通道检测：工具T" ~ requested_tool ~ "的通道为空或未知，正在检测..." %}
                        MMU_LOG MSG="{log_msg2}"
                        {% if not printer.mmu.is_homed %}
                            MMU_HOME
                        {% endif %}
                        MMU_CHECK_GATE TOOLS={requested_tool}
                    {% endif %}
                {% else %}
                    {% set log_msg3 = "单通道检测：工具T" ~ requested_tool ~ "的通道已加载（可用或缓冲可用），跳过检测。" %}
                    MMU_LOG MSG="{log_msg3}"
                {% endif %}
            {% else %}
                MMU_LOG MSG="单通道检测：工具未知，跳过检测。"
            {% endif %}
        {% else %}
            MMU_LOG MSG="检测跳过：当前为旁路模式。"
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_MMU_RUN_MARKERS VARIABLE=mmu_start_check_run VALUE={True}